import React, { useState } from 'react';
import { Copy, Check, Send, Sparkles } from 'lucide-react';

const PRGenerator = ({ lang = 'ja' }) => {
    const [formData, setFormData] = useState({
        type: 'nation',
        name: '',
        leader: '',
        capital: '',
        coords: '',
        concept: '',
        description: '',
        discord: '',
    });

    const [copied, setCopied] = useState(false);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const generateMarkdown = () => {
        if (formData.type === 'nation') {
            return `### ${formData.name}
- **ä¸»æ¨©è€…**: ${formData.leader}
- **é¦–éƒ½**: ${formData.capital}
- **ç‰¹å¾´**: ${formData.concept}
- **è©³ç´°**: ${formData.description}
- **å‚åŠ æ–¹æ³•**: ${formData.discord}`;
        } else {
            return `### ${formData.name}
- **ç”ºé•·**: ${formData.leader}
- **æ‰€å±å›½å®¶**: ${formData.capital || 'ç„¡æ‰€å±'}
- **åº§æ¨™**: ${formData.coords}
- **ç´¹ä»‹**: ${formData.description}
- **ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${formData.concept}`;
        }
    };

    const generateDiscord = () => {
        const emoji = formData.type === 'nation' ? 'ğŸŒ' : 'ğŸ˜ï¸';
        return `${emoji} **ã€${formData.type === 'nation' ? 'å›½å®¶å®£ä¼' : 'ç”ºå®£ä¼'}ã€‘ ${formData.name}** ${emoji}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ **${formData.type === 'nation' ? 'ä¸»æ¨©è€…' : 'ç”ºé•·'}**: ${formData.leader}
${formData.type === 'nation' ? `ğŸ›ï¸ **é¦–éƒ½**: ${formData.capital}` : `ğŸ“ **åº§æ¨™**: ${formData.coords}`}
âœ¨ **ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${formData.concept}
ğŸ“ **ç´¹ä»‹**: ${formData.description}
ğŸ”— **é€£çµ¡å…ˆ**: ${formData.discord}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#MARV #ãƒã‚¤ãƒ³ã‚¯ãƒ©ãƒ•ãƒˆ #å»ºå›½é¯–`;
    };

    const submitToGithub = () => {
        const title = encodeURIComponent(`[å®£ä¼æ²è¼‰ç”³è«‹] ${formData.name}`);
        const body = encodeURIComponent(`## å®£ä¼æ²è¼‰ç”³è«‹ (Wiki Promotion Request)

ä»¥ä¸‹ã®å†…å®¹ã‚’Wikiã«æ²è¼‰ã—ã¦ãã ã•ã„ï¼š

\`\`\`markdown
${generateMarkdown()}
\`\`\`

---
*Generated by MarvWiki PR Generator*`);

        const repoUrl = "https://github.com/Earth-Router/Marvwiki/issues/new";
        window.open(`${repoUrl}?title=${title}&body=${body}`, '_blank');
    };

    const submitToDiscord = async () => {
        // Use environment variable for the webhook URL
        const WEBHOOK_URL = import.meta.env.VITE_DISCORD_WEBHOOK_URL;

        if (!WEBHOOK_URL || WEBHOOK_URL.includes('YOUR_WEBHOOK_ID')) {
            alert(lang === 'ja' ? 'Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' : 'Webhook URL is not configured. Please check your .env file.');
            return;
        }

        const embed = {
            title: formData.type === 'nation' ? 'ğŸŒ æ–°è¦å›½å®¶æ²è¼‰ç”³è«‹' : 'ğŸ˜ï¸ æ–°è¦ç”ºæ²è¼‰ç”³è«‹',
            color: formData.type === 'nation' ? 0x3366cc : 0x2da44e,
            fields: [
                { name: 'åç§°', value: formData.name, inline: true },
                { name: 'ä»£è¡¨è€…', value: formData.leader, inline: true },
                { name: formData.type === 'nation' ? 'é¦–éƒ½' : 'æ‰€å±å›½', value: formData.capital || 'N/A', inline: true },
                { name: 'åº§æ¨™/é€£çµ¡å…ˆ', value: formData.coords || formData.discord || 'N/A' },
                { name: 'ã‚³ãƒ³ã‚»ãƒ—ãƒˆ', value: formData.concept },
                { name: 'è©³ç´°', value: formData.description }
            ],
            footer: { text: 'Submitted via MarvWiki PR Generator' }
        };

        try {
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ embeds: [embed] })
            });

            if (response.ok) {
                alert(lang === 'ja' ? 'Discordã«é€ä¿¡ã—ã¾ã—ãŸï¼' : 'Sent to Discord!');
            } else {
                throw new Error('Failed to send');
            }
        } catch (err) {
            console.error(err);
            alert(lang === 'ja' ? 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Webhookã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' : 'Failed to send. Please check Webhook settings.');
        }
    };

    const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };

    const t = {
        ja: {
            title: 'ç°¡å˜PRã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼',
            subtitle: 'å¿…è¦äº‹é …ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§ã€Wikiç”¨ã¨Discordç”¨ã®å®£ä¼æ–‡ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚',
            type: 'ç¨®é¡',
            nation: 'å›½å®¶',
            town: 'ç”º',
            name: 'åç§°',
            leader: 'ä»£è¡¨è€…å',
            capital: 'æ‰€å±å›½ / é¦–éƒ½',
            coords: 'åº§æ¨™ (x, z)',
            concept: 'ã‚³ãƒ³ã‚»ãƒ—ãƒˆãƒ»ç‰¹å¾´',
            description: 'è©³ç´°èª¬æ˜',
            discord: 'Discord / é€£çµ¡å…ˆ',
            preview: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
            copyWiki: 'Wikiç”¨ã‚³ãƒ”ãƒ¼',
            copyDiscord: 'Discordç”¨ã‚³ãƒ”ãƒ¼',
            submitGithub: 'Wikiã«æ²è¼‰ç”³è«‹ã™ã‚‹ (GitHub)',
            copied: 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'
        },
        en: {
            title: 'Quick PR Generator',
            subtitle: 'Fill in the details to generate promotion text for Wiki and Discord automatically.',
            type: 'Type',
            nation: 'Nation',
            town: 'Town',
            name: 'Name',
            leader: 'Leader',
            capital: 'Nation / Capital',
            coords: 'Coordinates (x, z)',
            concept: 'Concept / Features',
            description: 'Description',
            discord: 'Discord / Contact',
            preview: 'Preview',
            copyWiki: 'Copy for Wiki',
            copyDiscord: 'Copy for Discord',
            submitGithub: 'Submit to Wiki (GitHub)',
            copied: 'Copied!'
        }
    }[lang];

    return (
        <div className="pr-generator">
            <div className="generator-header">
                <h2><Sparkles size={24} style={{ color: '#3366cc', marginRight: '10px' }} />{t.title}</h2>
                <p>{t.subtitle}</p>
            </div>

            <div className="generator-grid">
                <div className="generator-form">
                    <div className="form-group">
                        <label>{t.type}</label>
                        <div className="radio-group">
                            <button
                                className={formData.type === 'nation' ? 'active' : ''}
                                onClick={() => setFormData(prev => ({ ...prev, type: 'nation' }))}
                            >{t.nation}</button>
                            <button
                                className={formData.type === 'town' ? 'active' : ''}
                                onClick={() => setFormData(prev => ({ ...prev, type: 'town' }))}
                            >{t.town}</button>
                        </div>
                    </div>

                    <div className="form-group">
                        <label>{t.name}</label>
                        <input name="name" value={formData.name} onChange={handleInputChange} placeholder={formData.type === 'nation' ? 'ä¾‹: ãƒãƒ«ãƒ´å¸å›½' : 'ä¾‹: ã‚¹ãƒãƒ³ã‚¸ç”º'} />
                    </div>

                    <div className="form-group">
                        <label>{t.leader}</label>
                        <input name="leader" value={formData.leader} onChange={handleInputChange} placeholder="Minecraft ID" />
                    </div>

                    <div className="form-group">
                        <label>{formData.type === 'nation' ? t.capital.split(' / ')[1] : t.capital.split(' / ')[0]}</label>
                        <input
                            name="capital"
                            value={formData.capital}
                            onChange={handleInputChange}
                            placeholder={formData.type === 'nation' ? 'ä¾‹: æœ¬æ‹ åœ°ã®åå‰' : 'ä¾‹: æ‰€å±ã—ã¦ã„ã‚‹å›½'}
                        />
                    </div>

                    {formData.type === 'town' && (
                        <div className="form-group">
                            <label>{t.coords}</label>
                            <input name="coords" value={formData.coords} onChange={handleInputChange} placeholder="ä¾‹: 1000, -2000" />
                        </div>
                    )}

                    <div className="form-group">
                        <label>{t.concept}</label>
                        <input name="concept" value={formData.concept} onChange={handleInputChange} placeholder="ä¾‹: å»ºç¯‰é‡è¦– / åˆå¿ƒè€…æ­“è¿" />
                    </div>

                    <div className="form-group">
                        <label>{t.description}</label>
                        <textarea name="description" value={formData.description} onChange={handleInputChange} rows="4" placeholder="ã‚ãªãŸã®å›½ã‚„ç”ºã®é­…åŠ›ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„ã€‚" />
                    </div>

                    <div className="form-group">
                        <label>{t.discord}</label>
                        <input name="discord" value={formData.discord} onChange={handleInputChange} placeholder="Discordã®æ‹›å¾…ãƒªãƒ³ã‚¯ãªã©" />
                    </div>
                </div>

                <div className="generator-preview">
                    <h3>{t.preview}</h3>

                    <div className="preview-box">
                        <div className="preview-label">Wiki (Markdown)</div>
                        <pre>{generateMarkdown()}</pre>
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button className="copy-btn" onClick={() => copyToClipboard(generateMarkdown())}>
                                {copied ? <Check size={14} /> : <Copy size={14} />} {t.copyWiki}
                            </button>
                            <button className="submit-btn" onClick={submitToGithub}>
                                <Github size={14} /> {t.submitGithub}
                            </button>
                            <button className="discord-submit-btn" onClick={submitToDiscord}>
                                <MessageCircle size={14} /> {lang === 'ja' ? 'Discordã«ç›´æ¥é€ã‚‹' : 'Submit to Discord'}
                            </button>
                        </div>
                    </div>

                    <div className="preview-box">
                        <div className="preview-label">Discord (Formatted)</div>
                        <pre>{generateDiscord()}</pre>
                        <button className="copy-btn" onClick={() => copyToClipboard(generateDiscord())}>
                            {copied ? <Check size={14} /> : <Copy size={14} />} {t.copyDiscord}
                        </button>
                    </div>

                    <div className="hint-box">
                        <Send size={16} />
                        <p>{lang === 'ja' ? 'ç”Ÿæˆã—ãŸæ–‡ç« ã‚’Wikiç·¨é›†è€…ã«é€ã‚‹ã‹ã€Discordã®å›½è¡—å®£ä¼ãƒãƒ£ãƒ³ãƒãƒ«ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼' : 'Send the generated text to a Wiki editor or paste it into the Discord channel!'}</p>
                    </div>
                </div>
            </div>
        </div>
    );
};

export default PRGenerator;
