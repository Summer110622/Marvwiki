import React, { useState } from 'react';
import { Copy, Check, Send, Sparkles, Github, MessageCircle, X, Code, Layout, AlertTriangle } from 'lucide-react';
import Editor from '@monaco-editor/react';

const PRGenerator = ({ lang = 'ja' }) => {
    const [mode, setMode] = useState('form'); // 'form' or 'editor'
    const [formData, setFormData] = useState({
        type: 'nation',
        name: '',
        leader: '',
        capital: '',
        coords: '',
        concept: '',
        description: '',
        discord: '',
    });

    const [customMarkdown, setCustomMarkdown] = useState('');
    const [copied, setCopied] = useState(false);
    const [showModal, setShowModal] = useState(false);

    const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData(prev => ({ ...prev, [name]: value }));
    };

    const generateMarkdown = () => {
        if (mode === 'editor') {
            return customMarkdown || '### [æœ¬æ–‡ã‚’è¨˜è¼‰ã—ã¦ãã ã•ã„]';
        }

        if (formData.type === 'nation') {
            return `### ${formData.name || '[å›½å®¶å]'}
- **ä¸»æ¨©è€…**: ${formData.leader || '[ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å]'}
- **é¦–éƒ½**: ${formData.capital || '[ç”ºå]'}
- **ç‰¹å¾´**: ${formData.concept || '[ç‰¹å¾´]'}
- **è©³ç´°**: ${formData.description || '[ç´¹ä»‹æ–‡]'}
- **å‚åŠ æ–¹æ³•**: ${formData.discord || '[é€£çµ¡å…ˆ]'}`;
        } else {
            return `### ${formData.name || '[ç”ºå]'}
- **ç”ºé•·**: ${formData.leader || '[ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼å]'}
- **æ‰€å±å›½å®¶**: ${formData.capital || 'ç„¡æ‰€å±'}
- **åº§æ¨™**: ${formData.coords || '[x, z]'}
- **ç´¹ä»‹**: ${formData.description || '[ç´¹ä»‹æ–‡]'}
- **ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${formData.concept || '[ã‚³ãƒ³ã‚»ãƒ—ãƒˆ]'}`;
        }
    };

    const generateDiscord = () => {
        const emoji = formData.type === 'nation' ? 'ğŸŒ' : 'ğŸ˜ï¸';
        return `${emoji} **ã€${formData.type === 'nation' ? 'å›½å®¶å®£ä¼' : 'ç”ºå®£ä¼'}ã€‘ ${formData.name || '[åå‰]'}** ${emoji}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
ğŸ‘¤ **${formData.type === 'nation' ? 'ä¸»æ¨©è€…' : 'ç”ºé•·'}**: ${formData.leader || '[ä»£è¡¨è€…]'}
${formData.type === 'nation' ? `ğŸ›ï¸ **é¦–éƒ½**: ${formData.capital || '[é¦–éƒ½]'}` : `ğŸ“ **åº§æ¨™**: ${formData.coords || '[åº§æ¨™]'}`}
âœ¨ **ã‚³ãƒ³ã‚»ãƒ—ãƒˆ**: ${formData.concept || '[ã‚³ãƒ³ã‚»ãƒ—ãƒˆ]'}
ğŸ“ **ç´¹ä»‹**: ${formData.description || '[ç´¹ä»‹æ–‡]'}
ğŸ”— **é€£çµ¡å…ˆ**: ${formData.discord || '[é€£çµ¡å…ˆ]'}
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
#MARV #ãƒã‚¤ãƒ³ã‚¯ãƒ©ãƒ•ãƒˆ #å»ºå›½é¯–`;
    };

    const handleSubmitClick = () => {
        setShowModal(true);
    };

    const submitToGithub = () => {
        setShowModal(false);
        const title = encodeURIComponent(`[å®£ä¼æ²è¼‰ç”³è«‹] ${formData.name || 'æ–°è¦ç”³è«‹'}`);
        const body = encodeURIComponent(`## å®£ä¼æ²è¼‰ç”³è«‹ (Wiki Promotion Request)

ä»¥ä¸‹ã®å†…å®¹ã‚’Wikiã«æ²è¼‰ã—ã¦ãã ã•ã„ï¼š

\`\`\`markdown
${generateMarkdown()}
\`\`\`

---
*Generated by MarvWiki PR Generator*`);

        const repoUrl = "https://github.com/Earth-Router/Marvwiki/issues/new";
        window.open(`${repoUrl}?title=${title}&body=${body}`, '_blank');
    };

    const submitToDiscord = async () => {
        const WEBHOOK_URL = import.meta.env.VITE_DISCORD_WEBHOOK_URL;

        if (!WEBHOOK_URL || WEBHOOK_URL.includes('YOUR_WEBHOOK_ID')) {
            alert(lang === 'ja' ? 'Webhook URLãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚.envãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' : 'Webhook URL is not configured. Please check your .env file.');
            return;
        }

        let displayName = formData.name || (lang === 'ja' ? 'åç§°æœªè¨­å®š' : 'unnamed');

        // In editor mode, try to extract the name from the first H3 header
        if (mode === 'editor') {
            const match = customMarkdown.match(/^###\s+(.*)/m);
            if (match && match[1]) {
                displayName = match[1].trim();
            }
        }

        const embed = {
            title: `${formData.type === 'nation' ? 'ğŸŒ å›½å®¶æ²è¼‰ç”³è«‹' : 'ğŸ˜ï¸ ç”ºæ²è¼‰ç”³è«‹'}: ${displayName}`,
            color: formData.type === 'nation' ? 0x3366cc : 0x2da44e,
            description: mode === 'editor' ? 'â€»ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆã‚«ã‚¹ã‚¿ãƒ Markdownï¼‰ã‹ã‚‰ã®ç”³è«‹' : 'ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ã‹ã‚‰ã®ç”³è«‹',
            fields: mode === 'editor' ? [
                { name: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼', value: customMarkdown.substring(0, 500) + (customMarkdown.length > 500 ? '...' : '') || 'è¨˜è¿°ãªã—' }
            ] : [
                { name: 'åç§°', value: formData.name || 'N/A', inline: true },
                { name: 'ä»£è¡¨è€…', value: formData.leader || 'N/A', inline: true },
                { name: formData.type === 'nation' ? 'é¦–éƒ½' : 'æ‰€å±å›½', value: formData.capital || 'N/A', inline: true },
                { name: 'åº§æ¨™/é€£çµ¡å…ˆ', value: formData.coords || formData.discord || 'N/A' },
                { name: 'ã‚³ãƒ³ã‚»ãƒ—ãƒˆ', value: formData.concept || 'N/A' },
                { name: 'è©³ç´°', value: formData.description || 'N/A' }
            ],
            footer: { text: 'Submitted via MarvWiki PR Generator' }
        };

        const markdownContent = generateMarkdown();
        const blob = new Blob([markdownContent], { type: 'text/markdown' });
        const file = new File([blob], `${displayName}.md`, { type: 'text/markdown' });

        const formDataToSend = new FormData();
        formDataToSend.append('payload_json', JSON.stringify({ embeds: [embed] }));
        formDataToSend.append('file', file);

        try {
            const response = await fetch(WEBHOOK_URL, {
                method: 'POST',
                body: formDataToSend
            });

            if (response.ok) {
                alert(lang === 'ja' ? 'Discordã«é€ä¿¡ã—ã¾ã—ãŸï¼' : 'Sent to Discord!');
                setShowModal(false);
            } else {
                throw new Error('Failed to send');
            }
        } catch (err) {
            console.error(err);
            alert(lang === 'ja' ? 'é€ä¿¡ã«å¤±æ•—ã—ã¾ã—ãŸã€‚Webhookã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚' : 'Failed to send. Please check Webhook settings.');
        }
    };

    const copyToClipboard = (text) => {
        navigator.clipboard.writeText(text);
        setCopied(true);
        setTimeout(() => setCopied(false), 2000);
    };

    const switchToEditor = () => {
        if (!customMarkdown) {
            setCustomMarkdown(generateMarkdown());
        }
        setMode('editor');
    };

    const t = {
        ja: {
            title: 'ç°¡å˜PRã‚¸ã‚§ãƒãƒ¬ãƒ¼ã‚¿ãƒ¼',
            subtitle: 'å¿…è¦äº‹é …ã‚’å…¥åŠ›ã™ã‚‹ã ã‘ã§ã€Wikiç”¨ã¨Discordç”¨ã®å®£ä¼æ–‡ã‚’è‡ªå‹•ç”Ÿæˆã—ã¾ã™ã€‚',
            type: 'ç¨®é¡',
            nation: 'å›½å®¶',
            town: 'ç”º',
            name: 'åç§°',
            leader: 'ä»£è¡¨è€…å',
            capital: 'æ‰€å±å›½ / é¦–éƒ½',
            coords: 'åº§æ¨™ (x, z)',
            concept: 'ã‚³ãƒ³ã‚»ãƒ—ãƒˆãƒ»ç‰¹å¾´',
            description: 'è©³ç´°èª¬æ˜',
            discord: 'Discord / é€£çµ¡å…ˆ',
            preview: 'ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼',
            copyWiki: 'Wikiç”¨ã‚³ãƒ”ãƒ¼',
            copyDiscord: 'Discordç”¨ã‚³ãƒ”ãƒ¼',
            submitGithub: 'Wikiã«æ²è¼‰ç”³è«‹ã™ã‚‹',
            modalTitle: 'ç”³è«‹æ–¹æ³•ã®é¸æŠ',
            modalDesc: 'GitHubã‚¢ã‚«ã‚¦ãƒ³ãƒˆã‚’ãŠæŒã¡ã§ã™ã‹ï¼Ÿ',
            hasAccount: 'æŒã£ã¦ã„ã‚‹ (GitHubã§ç”³è«‹)',
            noAccount: 'æŒã£ã¦ã„ãªã„ (Discordã§ç›´æ¥é€ã‚‹)',
            githubWarning: 'â€»GitHubç‰ˆã¯æ‰‹å‹•åæ˜ ã®ãŸã‚ã€å¯¾å¿œãŒé…ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚',
            formMode: 'ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›',
            editorMode: 'ã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ (VSCodeé¢¨)',
            copied: 'ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼'
        },
        en: {
            title: 'Quick PR Generator',
            subtitle: 'Fill in the details to generate promotion text for Wiki and Discord automatically.',
            type: 'Type',
            nation: 'Nation',
            town: 'Town',
            name: 'Name',
            leader: 'Leader',
            capital: 'Nation / Capital',
            coords: 'Coordinates (x, z)',
            concept: 'Concept / Features',
            description: 'Description',
            discord: 'Discord / Contact',
            preview: 'Preview',
            copyWiki: 'Copy for Wiki',
            copyDiscord: 'Copy for Discord',
            submitGithub: 'Submit to Wiki',
            modalTitle: 'Choose Submission Method',
            modalDesc: 'Do you have a GitHub account?',
            hasAccount: 'Yes (Submit via GitHub)',
            noAccount: "No (Submit via Discord Webhook)",
            githubWarning: '*GitHub submissions may take longer to process due to manual review.',
            formMode: 'Form Mode',
            editorMode: 'VSCode Mode',
            copied: 'Copied!'
        }
    }[lang];

    return (
        <div className="pr-generator">
            <div className="generator-header">
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                    <h2><Sparkles size={24} style={{ color: '#3366cc', marginRight: '10px' }} />{t.title}</h2>
                    <div className="mode-selector">
                        <button className={mode === 'form' ? 'active' : ''} onClick={() => setMode('form')}>
                            <Layout size={14} /> {t.formMode}
                        </button>
                        <button className={mode === 'editor' ? 'active' : ''} onClick={switchToEditor}>
                            <Code size={14} /> {t.editorMode}
                        </button>
                    </div>
                </div>
                <p>{t.subtitle}</p>
            </div>

            <div className="generator-grid">
                <div className="generator-main">
                    {mode === 'form' ? (
                        <div className="generator-form">
                            <div className="form-group">
                                <label>{t.type}</label>
                                <div className="radio-group">
                                    <button
                                        className={formData.type === 'nation' ? 'active' : ''}
                                        onClick={() => setFormData(prev => ({ ...prev, type: 'nation' }))}
                                    >{t.nation}</button>
                                    <button
                                        className={formData.type === 'town' ? 'active' : ''}
                                        onClick={() => setFormData(prev => ({ ...prev, type: 'town' }))}
                                    >{t.town}</button>
                                </div>
                            </div>

                            <div className="form-group">
                                <label>{t.name}</label>
                                <input name="name" value={formData.name} onChange={handleInputChange} placeholder={formData.type === 'nation' ? 'ä¾‹: ãƒãƒ«ãƒ´å¸å›½' : 'ä¾‹: ã‚¹ãƒãƒ³ã‚¸ç”º'} />
                            </div>

                            <div className="form-group">
                                <label>{t.leader}</label>
                                <input name="leader" value={formData.leader} onChange={handleInputChange} placeholder="Minecraft ID" />
                            </div>

                            <div className="form-group">
                                <label>{formData.type === 'nation' ? t.capital.split(' / ')[1] : t.capital.split(' / ')[0]}</label>
                                <input
                                    name="capital"
                                    value={formData.capital}
                                    onChange={handleInputChange}
                                    placeholder={formData.type === 'nation' ? 'ä¾‹: æœ¬æ‹ åœ°ã®åå‰' : 'ä¾‹: æ‰€å±ã—ã¦ã„ã‚‹å›½'}
                                />
                            </div>

                            {formData.type === 'town' && (
                                <div className="form-group">
                                    <label>{t.coords}</label>
                                    <input name="coords" value={formData.coords} onChange={handleInputChange} placeholder="ä¾‹: 1000, -2000" />
                                </div>
                            )}

                            <div className="form-group">
                                <label>{t.concept}</label>
                                <input name="concept" value={formData.concept} onChange={handleInputChange} placeholder="ä¾‹: å»ºç¯‰é‡è¦– / åˆå¿ƒè€…æ­“è¿" />
                            </div>

                            <div className="form-group">
                                <label>{t.description}</label>
                                <textarea name="description" value={formData.description} onChange={handleInputChange} rows="4" placeholder="ã‚ãªãŸã®å›½ã‚„ç”ºã®é­…åŠ›ã‚’è‡ªç”±ã«æ›¸ã„ã¦ãã ã•ã„ã€‚" />
                            </div>

                            <div className="form-group">
                                <label>{t.discord}</label>
                                <input name="discord" value={formData.discord} onChange={handleInputChange} placeholder="Discordã®æ‹›å¾…ãƒªãƒ³ã‚¯ãªã©" />
                            </div>
                        </div>
                    ) : (
                        <div className="generator-editor">
                            <Editor
                                height="500px"
                                defaultLanguage="markdown"
                                theme="vs-dark"
                                value={customMarkdown}
                                onChange={(value) => setCustomMarkdown(value || '')}
                                options={{
                                    minimap: { enabled: false },
                                    fontSize: 14,
                                    wordWrap: 'on',
                                    scrollBeyondLastLine: false,
                                }}
                            />
                        </div>
                    )}
                </div>

                <div className="generator-preview">
                    <h3>{t.preview}</h3>

                    <div className="preview-box">
                        <div className="preview-label">Wiki (Markdown)</div>
                        <pre>{generateMarkdown()}</pre>
                        <div style={{ display: 'flex', gap: '10px' }}>
                            <button className="copy-btn" onClick={() => copyToClipboard(generateMarkdown())}>
                                {copied ? <Check size={14} /> : <Copy size={14} />} {t.copyWiki}
                            </button>
                            <button className="submit-btn" onClick={handleSubmitClick}>
                                <Sparkles size={14} /> {t.submitGithub}
                            </button>
                        </div>
                    </div>

                    {mode === 'form' && (
                        <div className="preview-box">
                            <div className="preview-label">Discord (Formatted)</div>
                            <pre>{generateDiscord()}</pre>
                            <button className="copy-btn" onClick={() => copyToClipboard(generateDiscord())}>
                                {copied ? <Check size={14} /> : <Copy size={14} />} {t.copyDiscord}
                            </button>
                        </div>
                    )}

                    <div className="hint-box">
                        <Send size={16} />
                        <p>{lang === 'ja' ? 'ç”Ÿæˆã—ãŸæ–‡ç« ã‚’Wikiã«é€ã‚‹ã‹ã€Discordã®å›½è¡—å®£ä¼ãƒãƒ£ãƒ³ãƒãƒ«ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼' : 'Send the generated text to the Wiki or paste it into the Discord channel!'}</p>
                    </div>
                </div>
            </div>

            {showModal && (
                <div className="modal-overlay">
                    <div className="modal-content">
                        <button className="modal-close" onClick={() => setShowModal(false)}>
                            <X size={20} />
                        </button>
                        <h3>{t.modalTitle}</h3>
                        <p>{t.modalDesc}</p>
                        <div className="modal-buttons">
                            <button className="modal-btn github" onClick={submitToGithub}>
                                <div style={{ display: 'flex', flexDirection: 'column', alignItems: 'center', gap: '5px' }}>
                                    <div style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                                        <Github size={18} />
                                        {t.hasAccount}
                                    </div>
                                    <span className="warning-text" style={{ fontSize: '0.7rem', opacity: 0.8 }}>
                                        <AlertTriangle size={10} style={{ marginRight: '4px' }} />
                                        {t.githubWarning}
                                    </span>
                                </div>
                            </button>
                            <button className="modal-btn discord" onClick={submitToDiscord}>
                                <MessageCircle size={18} />
                                {t.noAccount}
                            </button>
                        </div>
                    </div>
                </div>
            )}
        </div>
    );
};

export default PRGenerator;
